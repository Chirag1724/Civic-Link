import{compile as M,normalizePath as V}from"@tailwindcss/node";import{clearRequireCache as q}from"@tailwindcss/node/require-cache";import{Scanner as C}from"@tailwindcss/oxide";import{Features as y,transform as D}from"lightningcss";import g from"path";function K(){let a=[],r=null,l=!1,u=!1,m=[],o=new Set,f=new C({}),d=new v(t=>new b(t,()=>o,r.base));function w(t,e,n,s){let i=!1;for(let c of f.scanFiles([{content:e,extension:n}]))i=!0,o.add(c);i&&R(s)}function R(t){for(let e of a){let n=[];for(let s of d.keys()){let i=e.moduleGraph.getModuleById(s);if(!i){t||d.delete(s);continue}d.get(s).requiresRebuild=!1,e.moduleGraph.invalidateModule(i),n.push({type:`${i.type}-update`,path:i.url,acceptedPath:i.url,timestamp:Date.now()})}n.length>0&&e.hot.send({type:"update",updates:n})}}async function x(t,e){let n=t.lastContent,s=await t.generate(n,e);if(s!==!1)return G(s,{minify:u})}async function F(t,e,n){let s={...t,getCombinedSourcemap:()=>{throw new Error("getCombinedSourcemap not implemented")}};for(let i of m){if(!i.transform)continue;let c="handler"in i.transform?i.transform.handler:i.transform;try{let p=await c.call(s,n,e);if(!p)continue;typeof p=="string"?n=p:p.code&&(n=p.code)}catch{console.error(`Error running ${i.name} on Tailwind CSS output. Skipping.`)}}return n}return[{name:"@tailwindcss/vite:scan",enforce:"pre",configureServer(t){a.push(t)},async configResolved(t){r=t,u=r.build.cssMinify!==!1,l=r.build.ssr!==!1&&r.build.ssr!==void 0;let e=["vite:css",...r.command==="build"?["vite:css-post"]:[]];m=r.plugins.filter(n=>e.includes(n.name))},transformIndexHtml(t,{path:e}){w(e,t,"html",l)},transform(t,e,n){let s=P(e);h(e)||w(e,t,s,n?.ssr??!1)}},{name:"@tailwindcss/vite:generate:serve",apply:"serve",enforce:"pre",async transform(t,e,n){if(!h(e))return;let s=d.get(e);n?.ssr||await Promise.all(a.map(c=>c.waitForRequestsIdle(e)));let i=await s.generate(t,c=>this.addWatchFile(c));return i?{code:i}:(d.delete(e),t)}},{name:"@tailwindcss/vite:generate:build",apply:"build",enforce:"pre",async transform(t,e){if(!h(e))return;let s=await d.get(e).generate(t,i=>this.addWatchFile(i));return s?{code:s}:(d.delete(e),t)},async renderStart(){for(let[t,e]of d.entries()){let n=await x(e,()=>{});if(!n){d.delete(t);continue}await F(this,t,n)}}}]}function P(a){let[r]=a.split("?",2);return g.extname(r).slice(1)}function h(a){let r=P(a);return r==="css"||r==="vue"&&a.includes("&lang.css")||r==="astro"&&a.includes("&lang.css")}function G(a,{file:r="input.css",minify:l=!1}={}){return D({filename:r,code:Buffer.from(a),minify:l,sourceMap:!1,drafts:{customMedia:!0},nonStandard:{deepSelectorCombinator:!0},include:y.Nesting,exclude:y.LogicalProperties,targets:{safari:16<<16|1024},errorRecovery:!0}).code.toString()}function S(a){return g.resolve(a.replace(/\?.*$/,""))}var v=class extends Map{constructor(l){super();this.factory=l}get(l){let u=super.get(l);return u===void 0&&(u=this.factory(l,this),this.set(l,u)),u}},b=class{constructor(r,l,u){this.id=r;this.getSharedCandidates=l;this.base=u}lastContent="";compiler;requiresRebuild=!0;scanner;candidates=new Set;dependencies=new Set;async generate(r,l){this.lastContent=r;let u=S(this.id),m=g.dirname(g.resolve(u));(!this.compiler||!this.scanner||this.requiresRebuild)&&(q(Array.from(this.dependencies)),this.dependencies=new Set([S(u)]),this.compiler=await M(r,{base:m,onDependency:o=>{l(o),this.dependencies.add(o)}}),this.scanner=new C({sources:this.compiler.globs}));for(let o of this.scanner.scan())this.candidates.add(o);for(let o of this.scanner.files)l(o);for(let o of this.scanner.globs){if(o.pattern[0]==="!")continue;let f=g.relative(this.base,o.base);f[0]!=="."&&(f="./"+f),f=V(f),l(g.posix.join(f,o.pattern))}return this.requiresRebuild=!0,this.compiler.build([...this.getSharedCandidates(),...this.candidates])}};export{K as default};
